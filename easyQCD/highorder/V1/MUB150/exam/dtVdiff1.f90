MODULE DTVDIFF_MOD
CONTAINS
SUBROUTINE DTVDIFF1(K,ETAPSI,ETAPHI,MP2K,MS2K,MF2K,KAPPAK,HK,GK,ZPHIK,L,LB,DTVD1L,DTVD1LB)
!THIS SUBROUTINE CALCULATE VARIOUS DIFFERENTIAL KERNAL CORRESPONDING 0<K<K_UV

  USE CONST_SAVE , ONLY : NF,NC,V3,PI
  USE TMU_MOD
  USE STRUCFUN_MOD
  USE FNF_MOD
  USE DETAPSIDLLB_MOD
  USE DETAPHIDLLB_MOD
  USE FNB_MOD
  USE RHOIR_MOD

  IMPLICIT NONE

  REAL(16),INTENT(IN) :: K,ETAPSI,ETAPHI,MP2K,MS2K,MF2K
  REAL(16),INTENT(IN) :: KAPPAK,HK,GK,ZPHIK,L,LB
  REAL(16),INTENT(OUT) :: DTVD1L,DTVD1LB
  REAL(16) :: MF2,MP2,MS2
  REAL(16) :: XFF,XFA
  REAL(16) :: NF0,NF1,NF2,NFF,NFA
  REAL(16) :: NFD1L,NFD1LB,NB,NBPION,NBSIGMA
  REAL(16) :: NFD1LF,NFD1LBF,NFD1LA,NFD1LBA
  REAL(16) :: ETAPSID1L,ETAPSID1LB,ETAPHID1L,ETAPHID1LB,RHOK

  RHOK=RHO_IR*ZPHIK/ZPHI_IR
  MF2=(Hk**2*RHOK)/(K**2*NF)!MF2K/(K**2)
  MP2=MP2K/(K**2)
  MS2=MS2K/(K**2)

  CALL FNB(K*SQRT(1.Q+0 + MP2),T,NB)
  NBPION=NB
  CALL FNB(K*SQRT(1.Q+0 + MS2),T,NB)
  NBSIGMA=NB

  XFF=-MU + (K*SQRT(1.Q+0 + MF2))
  XFA=MU + (K*SQRT(1.Q+0 + MF2))

  CALL FNF012(XFF,T,L,LB,NF0,NF1,NF2)

  NFF=NF0 + LB*NF1 + L*NF2
  NFD1L=-(NF2*(-1 + 3*NF0 + 3*LB*NF1 + 3*L*NF2))
  NFD1LB=-(NF1*(-2 + 3*NF0 + 3*LB*NF1 + 3*L*NF2))/2.Q+0

  NFD1LF=NFD1L
  NFD1LBF=NFD1LB

  CALL FNF012(XFA,T,LB,L,NF0,NF1,NF2)

  NFA=NF0 + L*NF1 + LB*NF2
  NFD1L=-(NF2*(-1 + 3*NF0 + 3*L*NF1 + 3*LB*NF2))
  NFD1LB=-(NF1*(-2 + 3*NF0 + 3*L*NF1 + 3*LB*NF2))/2.Q+0

  NFD1LA=NFD1L
  NFD1LBA=NFD1LB

  CALL DETAPSIDLLB(MP2,MS2,MF2,L,LB,K,HK,GK,ETAPHI,ETAPSI,ETAPSID1L,ETAPSID1LB)
  CALL DETAPHIDLLB(MF2,L,LB,K,HK,ETAPSI,ETAPHID1L,ETAPHID1LB)

  !DTVD1L=(-2*(1 - ETAPSI/4.Q+0)*K**4*NC*NF*(-NFD1LBA - NFD1LF)*V3)/(3.Q+0*SQRT(1.Q+0 + MF2))
  !DTVD1LB=(-2*(1 - ETAPSI/4.Q+0)*K**4*NC*NF*(-NFD1LA - NFD1LBF)*V3)/(3.Q+0*SQRT(1.Q+0 + MF2))
  DTVD1L=(k**4*((-2*etaphid1l*(0.5 + nbSigma))/(15.*Sqrt(1 + ms2))         &
  - (2*etaphid1l*(0.5 + nbPion)*(-1 + Nf**2))/(15.*Sqrt(1 + mp2))   &
  - (4*(1 - etapsi/4.)*Nc*Nf*(-nfd1lba - nfd1lf))/(3.*Sqrt(1 + mf2))& 
  + (etapsid1l*Nc*Nf*(1 - nfa - nff))/(3.*Sqrt(1 + mf2)))*v3)/2.
  DTVD1LB=(k**4*((-2*etaphid1lb*(0.5 + nbSigma))/(15.*Sqrt(1 + ms2))       &
  - (2*etaphid1lb*(0.5 + nbPion)*(-1 + Nf**2))/(15.*Sqrt(1 + mp2))  &
  - (4*(1 - etapsi/4.)*Nc*Nf*(-nfd1la - nfd1lbf))/(3.*Sqrt(1 + mf2))& 
  + (etapsid1lb*Nc*Nf*(1 - nfa - nff))/(3.*Sqrt(1 + mf2)))*v3)/2.

END SUBROUTINE DTVDIFF1
END MODULE DTVDIFF_MOD
