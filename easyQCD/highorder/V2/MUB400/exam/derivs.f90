MODULE DERIVS_MOD
!Rui Wen 2021.01.16
CONTAINS
SUBROUTINE DERIVS(X,Y,DYDX)

  USE CONST_SAVE
  USE TMU_MOD
  USE POLYAKOV_COM , L => L_COM , LB => LB_COM
  USE STRUCFUN_MOD
  USE KRANGE_MOD , ONLY : K_UV
  USE MU0P0_COM

  USE ODEFUN_COM

  USE INT_QUATKLOOP_MOD
  USE ETA_T0_FUN_MOD
  USE IRFUN_MOD
  USE NBDX_MOD
  USE NFDX_MOD
  USE LTM_MOD

  USE F_THR_MOD
  USE BB_THR_MOD
  USE BF_THR_MOD
  IMPLICIT NONE

  REAL(16),INTENT(IN) :: X,Y(:)
  REAL(16),INTENT(OUT) :: DYDX(:)
  REAL(16) :: K 
  ! IR CUTOFF IN FLOW EQUATIONS

  REAL(16) DMBOSEDRHO(2,12)
  REAL(16) LAM0,LAM1,LAM2,LAM3,LAM4,LAM5
  REAL(16) H
  REAL(16) ZPHI,ZPSI,ZA,ZPHI_P0
  REAL(16) JL,JS,SL,SS,CK,KAPPA
  REAL(16) ETAPHI,ETAPSI,ETAA,ETAPHI_P0
  !MESON AND QUARK ANOMANOUS DIMENSION
  REAL(16) RHO 
  !PHI_A**2/2
  REAL(16) MP2,MS2,MF2
  REAL(16) MP2D1RHO,MP2D2RHO,MP2D3RHO,MP2D4RHO,MP2D5RHO
  REAL(16) MS2D1RHO,MS2D2RHO,MS2D3RHO,MS2D4RHO,MS2D5RHO
  REAL(16) MF2D1RHO
  REAL(16) DR0DTV,DR1DTV,DR2DTV,DR3DTV,DR4DTV,DR5DTV
  REAL(16) LBT(2,6),LFT(6)
  REAL(16) DMBO2DRHO(2,6),NBDNX(2,6)
  REAL(16) DMFE2DRHO(2)
  REAL(16) LBT0(2),LBT1(2),LBT2(2),LBT3(2),LBT4(2),LBT5(2)
  REAL(16) LFT0(2),LFT1(2),LFT2(2),LFT3(2),LFT4(2),LFT5(2)
  !TERMS OF DRDTV ,TERMS OF FUNCTION 26
  REAL(16) K44PI2
  !CALCULATE ACCELERATE,NO SENCE
  REAL(16) DLAM0DT,DLAM1DT,DLAM2DT,DLAM3DT,DLAM4DT,DLAM5DT,DLAM6DT,DLAM7DT
  REAL(16) DTH,DHDT
  REAL(16) DZPHIDT,DZPSIDT,DZADT,DZPHI_P0DT,DJLDT,DJSDT,DSLDT,DSSDT,DCKDT,DKAPPADT
  REAL(16) B2B1F1APS,B2B1F1ASP,B1B1F2APS,B1B1F3APS,B2B1F2APS,B2B1F2ASP,B2F3AP,B3F2AP

  REAL(16) DTA,DTLAMBDASIGMAPION
  REAL(16) NFF,NFD1XF,NFD2XF,NFD3XF,NFD4XF,NFD5XF,NFA,NFD1XA,NFD2XA,NFD3XA,NFD4XA,NFD5XA
  REAL(16) NFFFDNX(6),NFAFDNX(6)
  REAL(16) NBGLDNX(6),NBPIDNX(6),NBSGDNX(6)
  REAL(16) NBBDN(2),FINVEBDN(2)
  REAL(16) FINVEBADN(2),FINVEBBDN(2),NBBADN(2),NBBBDN(2)
  REAL(16) NBBA,NBBB,NBBAD1,NBBBD1
  REAL(16) FINVEBA,FINVEBB,FINVEBAD1,FINVEBBD1

  REAL(16) B2F1AP,B1F2P,B2F2AP,B1F3P,B3F1AP
  REAL(16) B2F1AS,B1F2S,B2F2AS,B1F3S
  REAL(16) B2F1AA,B1F2A,B2F2AA,B1F3A,B3F1AA,B3F2AA,B2F3AA
  REAL(16) B1F1AT,B2F1AAT,B1F2AT,B2F2AAT,B1F3AT,B3F1AAT
  REAL(16) B1F1A

  REAL(16) L11P,L11S,L11A
  REAL(16) B2B2PS
  REAL(16) MB2
  REAL(16) MB2A,MB2B
  REAL(16) F2A,F3A
  REAL(16) F1F1,F2F1,F1F1PHI,F2F1PHI
  REAL(16) F2AT,F3AT

  REAL(16) DTG,DTLAM4,DTG3A

  REAL(16) G
  REAL(16) ASHIFT,DASHIFT
  REAL(16) N21MP,N21MS,N21GA,N12A,L12A,L111PS,L11GA
  REAL(16) DTLAM4_GLUON
  REAL(16) DTG_GLUON,DTG_MESON,DTG_GLUON_T

  REAL(16) ETAA_QL,CTHINTE_QL

  REAL(16) ETAAT0,ETACT0
  REAL(16) G3A,GCCA
  REAL(16) FQL0,FQL1

  REAL(16) K_4D
  REAL(16) DMASS2S,PTDMASS2S

  REAL(16) MFS2,G_S,MA2
  REAL(16) B1F1AS,B2F1AAS,B1F2AS,B2F2AAS,B1F3AS,B3F1AAS,B3F2AAS,B2F3AAS
  REAL(16) FQL0_S,FQL1_S
  REAL(16) ETAA_QL_S
  REAL(16) DTG_S_GLUON,DTG_S
  REAL(16) ETAA_QL_S_T0
  REAL(16) ZMFS,MFS_MEV
  REAL(16) FQLPHI0,FQLPHI1,CTHINTE_QL_PHI

  REAL(16),PARAMETER :: AMFS=5.94662682612336Q+0
  REAL(16),PARAMETER :: BMFS=9.27021872765222Q+0
  REAL(16),PARAMETER :: CMFS=340.55322960490327Q+0
  REAL(16),PARAMETER :: DMFS=120.60128700488963Q+0

  REAL(16) :: MFS2_T0
  REAL(16) :: F2A_S,F3A_S,F4A_S
  REAL(16) :: NFF_S,NFA_S
  REAL(16) :: LFS_0,DLAM0DT_V2

  REAL(16),DIMENSION(11) :: BF_MES_THR_COM
  REAL(16),DIMENSION (6) :: BBF_THR_COM
  REAL(16),DIMENSION (8) :: BF_A_THR_COM
  REAL(16),DIMENSION (6) :: BF_AT_THR_COM

  K=K_UV*EXP(X)

  LAM0=Y(1)
  LAM1=Y(2)
  LAM2=Y(3)
  LAM3=Y(4)
  LAM4=Y(5)
  LAM5=Y(6)
  H   =Y(NH_BG+1)
  ZPHI=Y(NZ_BG+1)
  ZPSI=Y(NZ_BG+2)
  ZA  =Y(NZ_BG+3)
  ZPHI_P0=Y(NZ_BG+4)
  JL  =Y(NCK_BG+1)
  SL  =Y(NCK_BG+2)
  G   =Y(NG_BG+1)          
  !QUARK-GLUON INTERACTION
  G3A =Y(NG_BG+2)        
  !THREE GLUON INTERACTION
  G_S =Y(NG_BG+3)   
  !QUARK-GLUON INTERACTION FOR THE STRANGE QUARK

  KAPPA=SL**2/2.Q+0
  RHO=KAPPA 
  !CALCULATIONS ARE PERFORMED AT EXPANSION POINT KAPPA
  MU0=0.Q+0
  P0=PI*T
  P0C=PI*(T-1.Q+0)*EXP(-K/(PI*T))+PI

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  !MASS AND THEIR DERIVATIVES
  MP2=LAM1/K**2
  MP2D1RHO=LAM2/K**2
  MP2D2RHO=LAM3/K**2
  MP2D3RHO=LAM4/K**2
  MP2D4RHO=LAM5/K**2
  MP2D5RHO=0.Q+0
  MS2=(LAM1 + 2*LAM2*RHO)/K**2
  MS2D1RHO=(3.Q+0*LAM2 + 2*LAM3*RHO)/K**2
  MS2D2RHO=(5.Q+0*LAM3 + 2*LAM4*RHO)/K**2
  MS2D3RHO=(7.Q+0*LAM4 + 2*LAM5*RHO)/K**2
  MS2D4RHO=(9.Q+0*LAM5 )/K**2
  MS2D5RHO=0.Q+0

  MF2=(H**2*RHO)/(K**2*2.Q+0)
  MFS2=(SQRT(MF2)+120.Q+0/K)**2  
  !STRANGE QUARK MASS
  MF2D1RHO=H**2/(K**2*2.Q+0)

  IF(ABS(MS2-MP2)<1.Q-9*(MS2+MP2)/2.Q+0)THEN
    MS2=MP2+1.Q-6*(MS2+MP2)/2.Q+0
  END IF
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!  MA2=G**2*T**2*(NC/3.Q+0+NF/6.Q+0)
  CALL NBDX_COM(0.Q+0,T,K,NBGLDNX,NBBDN,FINVEBDN)
!  CALL NBDX_COM(MA2,T,K,NBGLDNX,NBBDN,FINVEBDN)

  CALL NFDX_COM(MFS2,T,MU,L,LB,K,NFFFDNX,NFAFDNX)
  NFF   =NFFFDNX(1)
  NFD1XF=NFFFDNX(2)
  NFD2XF=NFFFDNX(3)
  NFD3XF=NFFFDNX(4)
  NFD4XF=NFFFDNX(5)
  NFD5XF=NFFFDNX(6)

  NFA   =NFAFDNX(1)
  NFD1XA=NFAFDNX(2)
  NFD2XA=NFAFDNX(3)
  NFD3XA=NFAFDNX(4)
  NFD4XA=NFAFDNX(5)
  NFD5XA=NFAFDNX(6)

  NFF_S=NFFFDNX(1)
  NFA_S=NFAFDNX(1)
  CALL BF_A_THR(MFS2,T,K,NBGLDNX,NFFFDNX,NFAFDNX,BF_A_THR_COM)  
  !FOR STRANGE QUARK

  B1F1AS =BF_A_THR_COM(1)
  B2F1AAS=BF_A_THR_COM(2)
  B1F2AS =BF_A_THR_COM(3)
  B2F2AAS=BF_A_THR_COM(4)
  B1F3AS =BF_A_THR_COM(5)
  B3F1AAS=BF_A_THR_COM(6)
  B3F2AAS=BF_A_THR_COM(7)
  B2F3AAS=BF_A_THR_COM(8)

! QUARK LOOP IS CALCULATED IN WHAT FOLLOWS
  CALL INT_QUATKLOOP(.FALSE.,K,T,MU,L,LB,MFS2,NFFFDNX,NFAFDNX,F2A,F3A,FQL0_S,FQL1_S,FQLPHI0,FQLPHI1)

! THIS PART IS FOR STRANGE QUARK LOOP
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!FOR STRANGE QUARKS ABOVE
  CALL NFDX_COM(MF2,T,MU,L,LB,K,NFFFDNX,NFAFDNX)
  NFF   =NFFFDNX(1)
  NFD1XF=NFFFDNX(2)
  NFD2XF=NFFFDNX(3)
  NFD3XF=NFFFDNX(4)
  NFD4XF=NFFFDNX(5)
  NFD5XF=NFFFDNX(6)

  NFA   =NFAFDNX(1)
  NFD1XA=NFAFDNX(2)
  NFD2XA=NFAFDNX(3)
  NFD3XA=NFAFDNX(4)
  NFD4XA=NFAFDNX(5)
  NFD5XA=NFAFDNX(6)

  CALL NBDX_COM(MP2,T,K,NBPIDNX,NBBADN,FINVEBADN)
  CALL NBDX_COM(MS2,T,K,NBSGDNX,NBBBDN,FINVEBBDN)
  CALL F_THR(MF2,K,F2A,F3A,NFFFDNX,NFAFDNX)
  CALL FT_THR(MF2,K,F2AT,F3AT,NFFFDNX,NFAFDNX)
  CALL BF_MES_THR(MP2,MS2,MF2,T,K,NBPIDNX,NBSGDNX,NFFFDNX,NFAFDNX,BF_MES_THR_COM)
  B1F2P =BF_MES_THR_COM(1)
  B1F2S =BF_MES_THR_COM(2)
  B1F3P =BF_MES_THR_COM(3)
  B1F3S =BF_MES_THR_COM(4)
  B2F1AP=BF_MES_THR_COM(5)
  B2F1AS=BF_MES_THR_COM(6)
  B2F2AP=BF_MES_THR_COM(7)
  B2F2AS=BF_MES_THR_COM(8)
  B3F1AP=BF_MES_THR_COM(9)
  B2F3AP=BF_MES_THR_COM(10)
  B3F2AP=BF_MES_THR_COM(11)

  CALL BB_THR(MP2,MS2,K,FINVEBADN,FINVEBBDN,NBBADN,NBBBDN,B2B2PS)
  CALL BF_AT_THR(MF2,T,K,NBGLDNX,NFFFDNX,NFAFDNX,BF_AT_THR_COM)

  B1F1AT =BF_AT_THR_COM(1)
  B2F1AAT=BF_AT_THR_COM(2)
  B1F2AT =BF_AT_THR_COM(3)
  B2F2AAT=BF_AT_THR_COM(4)
  B1F3AT =BF_AT_THR_COM(5)
  B3F1AAT=BF_AT_THR_COM(6)

  CALL BF_A_THR(MF2,T,K,NBGLDNX,NFFFDNX,NFAFDNX,BF_A_THR_COM)

  !B1F1A =BF_A_THR_COM(1)
  !B2F1AA=BF_A_THR_COM(2)
  !B1F2A =BF_A_THR_COM(3)
  B2F2AA=BF_A_THR_COM(4)
  B1F3A =BF_A_THR_COM(5)
  B3F1AA=BF_A_THR_COM(6)
  B3F2AA=BF_A_THR_COM(7)
  B2F3AA=BF_A_THR_COM(8)

  MA2=(509.222**2+DMASS2S)/(ZA*K**2)
  CALL NBDX_COM(MA2,T,K,NBGLDNX,NBBDN,FINVEBDN)
  CALL BF_A_THR(MF2,T,K,NBGLDNX,NFFFDNX,NFAFDNX,BF_A_THR_COM)

  B1F1A =BF_A_THR_COM(1)
  B2F1AA=BF_A_THR_COM(2)
  B1F2A =BF_A_THR_COM(3)

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  K_4D=R_4D_TO_3D*K

  CALL ETA_A_T0_FUN(K_4D,ETAAT0)
  CALL ETA_C_T0(K_4D,ETACT0)

  GCCA=G

! QUARK LOOP IS CALCULATED IN WHAT FOLLOWS
  CALL INT_QUATKLOOP(.TRUE.,K,T,MU,L,LB,MF2,NFFFDNX,NFAFDNX,F2A,F3A,FQL0,FQL1,FQLPHI0,FQLPHI1)
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

  ETAPHI=(((FQLPHI0 - FQLPHI1)*H**2*NC*                                          &
       (4*B2F1AS*H**2 + C2NC*                                                    &
          (9*B1F1A - 18*B1F2A + 8*B2F1AA - 2*B2F1AA*ETAAT0)*G**2*NF +            &
         4*B2F1AP*H**2*(-1 + NF**2))*V3**2)/(6.Q+0*NF) -                            &
    (1 + ((B1F1A - 2*B1F2A)*C2NC*G**2*V3)/4.Q+0)*                                   &
     (2*FQLPHI0*H**2*NC*V3 - (4*B2B2PS*LAM2**2*RHO*V3)/(3.Q+0*K**2)))/              &
  (1 + ((B1F1A - 2*B1F2A)*C2NC*G**2*V3)/4.Q+0 +                                     &
    ((FQLPHI0 - FQLPHI1)*H**4*NC*(B2F1AS + B2F1AP*(-1 + NF**2))*V3**2)/          &
     (6.Q+0*NF))

  ETAPSI=-((B2F1AS*(-4 + ETAPHI)*H**2 +                                          &
       C2NC*(-9*B1F1A + 18*B1F2A + 2*B2F1AA*(-4 + (ETAAT0)))*G**2*NF +    &
       B2F1AP*(-4 + ETAPHI)*H**2*(-1 + NF**2))*V3)/                              &
  (3.Q+0*NF*(4 + B1F1A*C2NC*G**2*V3 - 2*B1F2A*C2NC*G**2*V3))

  ETAPHI_P0=((((-3 + 2*ETAPSI)*F2A - 4*(-2 + ETAPSI)*F3A)*H**2*NC +              &
            (4*B2B2PS*LAM2**2*RHO)/K**2)*V3)/3.Q+0

  !ETAPHI=ETAPHI_P0

!!!!!!!!!!!!!!!!!!!!!!
  MA2=0.Q+0
  CALL NBDX_COM(MA2,T,K,NBGLDNX,NBBDN,FINVEBDN)
  CALL BF_A_THR(MF2,T,K,NBGLDNX,NFFFDNX,NFAFDNX,BF_A_THR_COM)
          
  B1F1A =BF_A_THR_COM(1)
  B2F1AA=BF_A_THR_COM(2)
  B1F2A =BF_A_THR_COM(3)
!!!!!!!!!!!!!!!!!!!!!!
  ETAA_QL=2*((-1 + ETAPSI)*FQL0 - ETAPSI*FQL1)*G**2*NF*V3

  ETAA_QL_S=2*((-1 + ETAPSI)*FQL0_S - ETAPSI*FQL1_S)*G_S**2*1.Q+0*V3


  ZMFS=BMFS*(LOG(K)-AMFS)
  IF(ZMFS>80.Q+0)THEN
    MFS_MEV=DMFS
  ELSE
    MFS_MEV=CMFS/(EXP(ZMFS)+1.Q+0)+DMFS
  END IF

  MFS2_T0=(MFS_MEV/K)**2

  F2A_S=1.Q+0/(4.Q+0*(1 + MFS2_T0)**1.5)
  F3A_S=3.Q+0/(16.Q+0*(1 + MFS2_T0)**2.5)
  F4A_S=15.Q+0/(96.Q+0*(1 + MFS2_T0)**3.5)
  ETAA_QL_S_T0=1.Q+0/(30.Q+0*PI**2)*G_S**2*(3.Q+0*(-3.Q+0+2.Q+0*ETAPSI)*F2A_S+4.Q+0*(8.Q+0-3.Q+0*ETAPSI)*F3A_S-8.Q+0*F4A_S)

  ETAA_QL_S=ETAA_QL_S+ETAA_QL_S_T0

  ETAA=ETAAT0+ETAA_QL+ETAA_QL_S

  CALL MASSASCREEN(K,T,DMASS2S,PTDMASS2S)

  ETAA=ETAA+(2.Q+0-ETAA)*DMASS2S/(ZA*K**2)-PTDMASS2S/(ZA*K**2)

  !ETAPSI=-((B2F1AS*(-4 + ETAPHI)*H**2 +                                          &
  !     C2NC*(-9*B1F1A + 18*B1F2A + 2*B2F1AA*(-4 + (ETAA)))*G**2*NF +    &
  !     B2F1AP*(-4 + ETAPHI)*H**2*(-1 + NF**2))*V3)/                              &
  !(3.Q+0*NF*(4 + B1F1A*C2NC*G**2*V3 - 2*B1F2A*C2NC*G**2*V3))
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

  DTG_GLUON=3.Q+0/(4.Q+0*NC)*V3*G**3*MF2*(B2F2AA*((2.Q+0-ETAA)/3.Q+0+ETAA/5.Q+0)           &
       +2.Q+0*B1F3A*(2.Q+0/3.Q+0*(1.Q+0-ETAPSI)+ETAPSI/2.Q+0))                                 &
       +3.Q+0/4.Q+0*NC*V3*G**2*G3A*(B2F1AA*((1.Q+0-ETAPSI)/4.Q+0+ETAPSI/5.Q+0)                &
       -B1F2A*(2.Q+0/3.Q+0*(1.Q+0-ETAPSI)+ETAPSI/2.Q+0)-B2F2AA*(-(1.Q+0-ETAPSI)/6.Q+0-ETAPSI/10.Q+0) &
       -2.Q+0*B2F1AA*((2.Q+0-ETAA)/3.Q+0+ETAA/5.Q+0)-2.Q+0*B3F1AA*(-(2.Q+0-ETAA)/12.Q+0-ETAA/30.Q+0) )

  DTG_MESON= -1.Q+0/(4.Q+0*NF)*G*H**2*V3*( (B1F2S+2.Q+0*MF2*B1F3S)*(2.Q+0/3.Q+0*(1.Q+0-ETAPSI)    &
             +ETAPSI/2.Q+0)+(B2F1AS+MF2*B2F2AS)*((2.Q+0-ETAPHI)/3.Q+0+ETAPHI/5.Q+0) )       &
             -(NF**2-1.Q+0)/(4.Q+0*NF)*G*H**2*V3*( (B1F2P+2.Q+0*MF2*B1F3P)               &
             *(2.Q+0/3.Q+0*(1.Q+0-ETAPSI)+ETAPSI/2.Q+0)                                     &
             +(B2F1AP+MF2*B2F2AP)*((2.Q+0-ETAPHI)/3.Q+0+ETAPHI/5.Q+0) )

  DTG=((ETAA + 2*ETAPSI)*G)/2.Q+0+DTG_GLUON+DTG_MESON

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

  DTG_GLUON_T=3.Q+0/(4.Q+0*NC)*V3*G**3*MF2*(B2F2AAT*((2.Q+0-ETAA)/3.Q+0+ETAA/5.Q+0)            &
       +2.Q+0*B1F3AT*(2.Q+0/3.Q+0*(1.Q+0-ETAPSI)+ETAPSI/2.Q+0))                                &
       +3./4.Q+0*NC*V3*G**2*G3A*(B2F1AAT*((1.Q+0-ETAPSI)/4.Q+0+ETAPSI/5.Q+0)               &
       -B1F2AT*(2.Q+0/3.Q+0*(1.Q+0-ETAPSI)+ETAPSI/2.Q+0)-B2F2AAT*(-(1.Q+0-ETAPSI)/6.Q+0-ETAPSI/10.Q+0) &
       -2.Q+0*B2F1AAT*((2.Q+0-ETAA)/3.Q+0+ETAA/5.Q+0)-2.Q+0*B3F1AAT*(-(2.Q+0-ETAA)/12.Q+0-ETAA/30.Q+0) )

  DTG3A=((3.Q+0*ETAA)*G3A)/2.Q+0-1.Q+0/(6.Q+0*PI**2)*G**3*(1.Q+0-ETAPSI/4.Q+0)*(1.Q+0+2.Q+0*MF2)/(1.Q+0+MF2)**4    &
        +3.Q+0/(64.Q+0*PI**2)*G3A**3*(11.Q+0-2.Q+0*ETAA)                                   &
        +1.Q+0/(64.Q+0*PI**2)*GCCA**3*(1.Q+0-ETACT0/8.Q+0)                                 &
        -(1.Q+0/2.Q+0)*1.Q+0/(6.Q+0*PI**2)*G_S**3*(1.Q+0-ETAPSI/4.Q+0)*(1.Q+0+2.Q+0*MFS2)/(1.Q+0+MFS2)**4
  !NOTE ZERO TEMPERATURE!!!

  DTG3A=DTG3A+DTG_GLUON_T

  CALL IRENHA(K,ASHIFT,DASHIFT)

  DTG=DASHIFT*G + ASHIFT*DTG

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

  DTG_S_GLUON=3.Q+0/(4.Q+0*NC)*V3*G_S**3*MFS2*(B2F2AAS*((2.Q+0-ETAA)/3.Q+0+ETAA/5.Q+0)       &
       +2.Q+0*B1F3AS*(2./3.Q+0*(1.Q+0-ETAPSI)+ETAPSI/2.Q+0))                                 &
       +3.Q+0/4.Q+0*NC*V3*G_S**2*G3A*(B2F1AAS*((1.Q+0-ETAPSI)/4.Q+0+ETAPSI/5.Q+0)                &
       -B1F2AS*(2.Q+0/3.Q+0*(1.Q+0-ETAPSI)+ETAPSI/2.Q+0)-B2F2AAS*(-(1.Q+0-ETAPSI)/6.Q+0-ETAPSI/10.Q+0) &
       -2.Q+0*B2F1AAS*((2.Q+0-ETAA)/3.Q+0+ETAA/5.Q+0)-2.Q+0*B3F1AAS*(-(2.Q+0-ETAA)/12.Q+0-ETAA/30.Q+0) )

  DTG_S=((ETAA + 2*ETAPSI)*G_S)/2.Q+0+DTG_S_GLUON

  DTG_S=DASHIFT*G_S + ASHIFT*DTG_S

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

  DTLAM4_GLUON=-(3.Q+0/2.Q+0)*C2NC*(3.Q+0/4.Q+0-1.Q+0/NC**2)*(G**4)*(2.Q+0/K**2)*V3*              &
       (  (B3F1AA-MF2*B3F2AA)*((2.Q+0-ETAA)/3.Q+0+ETAA/5.Q+0)+(B2F2AA-2.Q+0*MF2*B2F3AA)*    &
           ((1.Q+0-ETAPSI)/3.Q+0+ETAPSI/4.Q+0)  )

  CALL BBF_THR(MP2,MS2,MF2,T,K,NBPIDNX,NBSGDNX,NFFFDNX,NFAFDNX,BBF_THR_COM)
  B2B1F1APS=BBF_THR_COM(1)
  B2B1F1ASP=BBF_THR_COM(2)
  B1B1F2APS=BBF_THR_COM(3)
  B1B1F3APS=BBF_THR_COM(4)
  B2B1F2APS=BBF_THR_COM(5)
  B2B1F2ASP=BBF_THR_COM(6)

  DTLAMBDASIGMAPION=H**4*V3/K**2*(NF**2-2.Q+0)/(16.Q+0*NF*NC)*(                        &
    (1.Q+0/3.Q+0*(2.Q+0-ETAPHI)+1.Q+0/5.Q+0*ETAPHI)*(B2B1F1ASP+B2B1F1APS                        &
    -MF2*(B2B1F2ASP+B2B1F2APS))+(2.Q+0/3.Q+0*(1.Q+0-ETAPSI)+1.Q+0/2.Q+0*ETAPSI)*(B1B1F2APS      &
    -2.Q+0*MF2*B1B1F3APS)-(2.Q+0/3.Q+0*(2.Q+0-ETAPHI)+2.Q+0/5.Q+0*ETAPHI)*(B3F1AP-MF2*B3F2AP)      &
    -(2.Q+0/3.Q+0*(1.Q+0-ETAPSI)+1.Q+0/2.Q+0*ETAPSI)*(B2F2AP-2.Q+0*MF2*B2F3AP))

  DTLAM4=DTLAMBDASIGMAPION+DTLAM4_GLUON
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  DTA=-K**2*DTLAM4/H
  
  L11P=(2*B2F1AP*(1 - ETAPHI/5.Q+0))/3.Q+0 + (2*B1F2P*(1 - ETAPSI/4.Q+0))/3.Q+0
  L11S=(2*B2F1AS*(1 - ETAPHI/5.Q+0))/3.Q+0 + (2*B1F2S*(1 - ETAPSI/4.Q+0))/3.Q+0
  L11A=(2*B2F1AA*(1 - ETAA/5.Q+0))/3.Q+0 + (2*B1F2A*(1 - ETAPSI/4.Q+0))/3.Q+0

  DTH=(ETAPHI/2.Q+0 + ETAPSI)*H - (H*(3*G**2*L11A*(-1 + NC**2)*NF +                &
       H**2*NC*(-L11S + L11P*(-1 + NF**2)))*V3)/(2.Q+0*NC*NF)
  
  DTH=DTH-MP2*DTA
  !DYNAMICAL HADRONIZATION
  DHDT=DTH
  
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

  DZPHIDT=-ETAPHI*ZPHI
  DZPSIDT=-ETAPSI*ZPSI
  DZADT=-ETAA*ZA
  DZPHI_P0DT=-ETAPHI_P0*ZPHI

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! !WR
  DMBO2DRHO(:,1)=(/MP2,MS2/)
  DMBO2DRHO(:,2)=(/MP2D1RHO,MS2D1RHO/)
  DMBO2DRHO(:,3)=(/MP2D2RHO,MS2D2RHO/)
  DMBO2DRHO(:,4)=(/MP2D3RHO,MS2D3RHO/)
  DMBO2DRHO(:,5)=(/MP2D4RHO,MS2D4RHO/)
  DMBO2DRHO(:,6)=(/MP2D5RHO,MS2D5RHO/)
  NBDNX(1,:)=NBPIDNX
  NBDNX(2,:)=NBSGDNX
  CALL LBTEM(K,DMBO2DRHO,NBDNX,ETAPHI,LBT)
  LBT0=LBT(:,1)
  LBT1=LBT(:,2)
  LBT2=LBT(:,3)
  LBT3=LBT(:,4)
  LBT4=LBT(:,5)
  LBT5=LBT(:,6)
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! !WR
  DMFE2DRHO=(/MF2,MF2D1RHO/)
  CALL LFTEM(K,DMFE2DRHO,NFFFDNX,NFAFDNX,ETAPSI,LFT)
  LFT0(1)=LFT(1)
  LFT1(1)=LFT(2)
  LFT2(1)=LFT(3)
  LFT3(1)=LFT(4)
  LFT4(1)=LFT(5)
  LFT5(1)=LFT(6)
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! !WR
  CALL LFTEM_STRANGE(K,MFS2,NFF_S,NFA_S,ETAPSI,LFS_0)
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! !WR
  K44PI2=K**4.Q+00/(4.Q+0*PI*PI)

  DR0DTV=K44PI2*(3*LBT0(1)+LBT0(2)-4.Q+00*NC*(2*(LFT0(1))))
  DR1DTV=K44PI2*(3*LBT1(1)+LBT1(2)-4.Q+00*NC*(2*(LFT1(1))))
  DR2DTV=K44PI2*(3*LBT2(1)+LBT2(2)-4.Q+00*NC*(2*(LFT2(1))))
  DR3DTV=K44PI2*(3*LBT3(1)+LBT3(2)-4.Q+00*NC*(2*(LFT3(1))))
  DR4DTV=K44PI2*(3*LBT4(1)+LBT4(2)-4.Q+00*NC*(2*(LFT4(1))))
  DR5DTV=K44PI2*(3*LBT5(1)+LBT5(2)-4.Q+00*NC*(2*(LFT5(1))))

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

  DJLDT=(1.Q+0/2.Q+0)*ETAPHI*JL

  DKAPPADT=(JL*DJLDT*LAM1-(DR1DTV+ETAPHI*(LAM1+KAPPA*LAM2))*JL**2)/(LAM1**3+LAM2*JL**2)

  DSLDT=DKAPPADT/SL

  DLAM0DT=DR0DTV+(DKAPPADT+ETAPHI*KAPPA)*LAM1
  DLAM1DT=1.Q+0*ETAPHI*LAM1+DR1DTV+(DKAPPADT+ETAPHI*KAPPA)*LAM2
  DLAM2DT=2.Q+0*ETAPHI*LAM2+DR2DTV+(DKAPPADT+ETAPHI*KAPPA)*LAM3
  DLAM3DT=3.Q+0*ETAPHI*LAM3+DR3DTV+(DKAPPADT+ETAPHI*KAPPA)*LAM4
  DLAM4DT=4.Q+0*ETAPHI*LAM4+DR4DTV+(DKAPPADT+ETAPHI*KAPPA)*LAM5
  DLAM5DT=5.Q+0*ETAPHI*LAM5+DR5DTV

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!potential with physical meson mass
  DMBO2DRHO(:,1)=(/MP2*1.63027**2,MS2*1.63027**2/)
  CALL NBDX_COM(MP2*1.63027**2,T,K,NBPIDNX,NBBADN,FINVEBADN)
  CALL NBDX_COM(MS2*1.63027**2,T,K,NBSGDNX,NBBBDN,FINVEBBDN)
!  DMBO2DRHO(:,1)=(/MP2,MS2/)
!  CALL NBDX_COM(MP2,T,K,NBPIDNX,NBBADN,FINVEBADN)
!  CALL NBDX_COM(MS2,T,K,NBSGDNX,NBBBDN,FINVEBBDN)
  NBDNX(1,:)=NBPIDNX
  NBDNX(2,:)=NBSGDNX

  CALL LBTEM(K,DMBO2DRHO,NBDNX,ETAPHI_P0,LBT)
  LBT0=LBT(:,1)

  DR0DTV=K44PI2*(3*LBT0(1)+LBT0(2)-4.Q+00*NC*(2*(LFT0(1))))
  DKAPPADT=(JL*DJLDT*LAM1-(DR1DTV+ETAPHI_P0*(LAM1+KAPPA*LAM2))*JL**2)/(LAM1**3+LAM2*JL**2)
  DLAM0DT_V2=DR0DTV+(DKAPPADT+ETAPHI_P0*KAPPA)*(LAM1)
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

  DYDX(1)=DLAM0DT
  DYDX(2)=DLAM1DT
  DYDX(3)=DLAM2DT
  DYDX(4)=DLAM3DT
  DYDX(5)=DLAM4DT
  DYDX(6)=DLAM5DT
  DYDX(NH_BG+1)=DHDT
  DYDX(NZ_BG+1)=DZPHIDT
  DYDX(NZ_BG+2)=DZPSIDT
  DYDX(NZ_BG+3)=DZADT
  DYDX(NZ_BG+4)=DZPHI_P0DT
  DYDX(NCK_BG+1)=DJLDT
  DYDX(NCK_BG+2)=DSLDT
  DYDX(NG_BG+1)=DTG
  DYDX(NG_BG+2)=DTG3A
  DYDX(NG_BG+3)=DTG_S
  DYDX(NG_BG+4)=DLAM0DT_V2

  FUNSAVE(1)=ETAPHI
  FUNSAVE(2)=ETAPSI
  FUNSAVE(3)=MF2*K**2
  FUNSAVE(4)=MP2*K**2
  FUNSAVE(5)=MS2*K**2
  FUNSAVE(6)=KAPPA
  FUNSAVE(7)=H
  FUNSAVE(8)=G
  FUNSAVE(9)=ZPHI

END SUBROUTINE DERIVS
END MODULE DERIVS_MOD
